{"version":3,"sources":["../../src/payu/payments.js"],"names":["Q","require","base64","md5","module","exports","payUUrlsMap","accountData","transactions","secureHash","encode","apiLogin","apiKey","authorizeAndCheckout","_data","deferred","defer","validationResult","errors","length","data","referenceCode","Math","floor","random","Date","now","signature","merchantId","purchaseData","value","currency","payments","headers","test","accountId","description","notifyUrl","personData","id","name","lastname","email","phone","legalId","shippingAddress","street","city","state","countryCode","postalCode","cardData","number","securityCode","expirationDate","type","requestDeviceData","sessionId","ipAddress","cookie","userAgent","then","resp","statusCode","resolve","body","reject","catch","err","promise"],"mappings":"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","file":"payments.js","sourcesContent":["import { httpRequest } from '../services/httpRequest';\nimport {validate as validateJSONSchema} from 'jsonschema';\nvar Q = require('q');\nvar base64 = require('base-64');\nvar md5 = require('md5');\n\nmodule.exports = function (payUUrlsMap, accountData) {\n    var transactions = {};\n    var secureHash = base64.encode(accountData.apiLogin+':'+accountData.apiKey);\n\n    // Authorize and check out\n    transactions.authorizeAndCheckout = function (_data) {\n        var deferred = Q.defer();\n        var validationResult = validateJSONSchema(\n            _data, {\n                \"type\": \"object\",\n                \"title\": \"Authorize and checkout transaction parameters\",\n                \"required\": [\"notifyUrl\", \"purchaseData\", \"personData\", \"cardData\", \"requestDeviceData\"],\n                \"properties\": {\n                    \"notifyUrl\": { \"type\": \"string\" },\n                    \"purchaseData\": {\n                        \"type\": \"object\",\n                        \"required\": [ \"description\", \"value\", \"currency\" ],\n                        \"properties\": {\n                            \"description\": { \"type\": \"string\" },\n                            \"currency\": { \"type\": \"string\" },\n                            \"value\": { \"type\": \"string\" }\n                        }\n                    },\n                    \"personData\": {\n                        \"type\": \"object\",\n                        \"required\": [ \"id\", \"name\", \"lastname\", \"email\", \"phone\", \"legalId\", \"shippingAddress\" ],\n                        \"properties\": {\n                            \"id\": { \"type\": \"string\" },\n                            \"name\": { \"type\": \"string\" },\n                            \"lastname\": { \"type\": \"string\" },\n                            \"email\": { \"type\": \"string\" },\n                            \"phone\": { \"type\": \"string\" },\n                            \"legalId\": { \"type\": \"string\" },\n                            \"shippingAddress\": {\n                                \"type\": \"object\",\n                                \"required\": [ \"street\", \"city\", \"state\", \"countryCode\", \"postalCode\"],\n                                \"properties\": {\n                                    \"street\": { \"type\": \"string\" },\n                                    \"city\": { \"type\": \"string\" },\n                                    \"state\": { \"type\": \"string\" },\n                                    \"countryCode\": { \"type\": \"string\" },\n                                    \"postalCode\": { \"type\": \"string\" }\n                                }\n                            }\n                        }\n                    },\n                    \"cardData\": {\n                        \"type\": \"object\",\n                        \"required\": [ \"number\", \"securityCode\", \"expirationDate\", \"name\", \"type\", \"countryCode\" ],\n                        \"properties\": {\n                            \"number\": { \"type\": \"string\" },\n                            \"securityCode\": { \"type\": \"string\" },\n                            \"expirationDate\": { \"type\": \"string\" },\n                            \"name\": { \"type\": \"string\" },\n                            \"type\": { \"type\": \"string\" },\n                            \"countryCode\": { \"type\": \"string\" }\n                        }\n                    },\n                    \"requestDeviceData\": {\n                        \"type\": \"object\",\n                        \"required\": [ \"ipAddress\", \"userAgent\"],\n                        \"properties\": {\n                            \"ipAddress\": { \"type\": \"string\" },\n                            \"userAgent\": { \"type\": \"string\" }\n                        }\n                    }\n                }\n            }\n        )\n        if (validationResult.errors.length) {\n            throw validationResult.errors;\n        }\n        var data = _data;\n        var referenceCode = \"authorize_and_checkout_\"+Math.floor(Math.random()*10000)+'-'+Math.floor(Date.now());\n        var signature = md5(accountData.apiKey+'~'+accountData.merchantId+'~'+referenceCode+'~'+data.purchaseData.value+'~'+data.purchaseData.currency);\n        httpRequest('POST', payUUrlsMap.payments, {\n            headers: {\n                'Authorization': 'Basic '+secureHash\n            },\n            data: {\n                \"test\": accountData.test,\n                \"language\": \"es\",\n                \"command\": \"SUBMIT_TRANSACTION\",\n                \"merchant\": {\n                    \"apiLogin\": accountData.apiLogin,\n                    \"apiKey\": accountData.apiKey\n                },\n                \"transaction\": {\n                   \"order\": {\n                      \"accountId\": accountData.accountId,\n                      \"referenceCode\": referenceCode,\n                      \"description\": data.purchaseData.description,\n                      \"language\": \"es\",\n                      \"signature\": signature,\n                      \"notifyUrl\": data.notifyUrl,\n                      \"additionalValues\": {\n                         \"TX_VALUE\": {\n                            \"value\": data.purchaseData.value,\n                            \"currency\": data.purchaseData.currency\n                         }\n                      },\n                      \"buyer\": {\n                         \"merchantBuyerId\": data.personData.id,\n                         \"fullName\": data.personData.name+' '+data.personData.lastname,\n                         \"emailAddress\": data.personData.email,\n                         \"contactPhone\": data.personData.phone,\n                         \"dniNumber\": data.personData.legalId,\n                         \"shippingAddress\": {\n                            \"street1\": data.personData.shippingAddress.street,\n                            \"street2\": \"\",\n                            \"city\": data.personData.shippingAddress.city,\n                            \"state\": data.personData.shippingAddress.state,\n                            \"country\": data.personData.shippingAddress.countryCode,\n                            \"postalCode\": data.personData.shippingAddress.postalCode,\n                            \"phone\": data.personData.phone\n                         }\n                      },\n                      \"shippingAddress\": {\n                        \"street1\": data.personData.shippingAddress.street,\n                        \"street2\": \"\",\n                        \"city\": data.personData.shippingAddress.city,\n                        \"state\": data.personData.shippingAddress.state,\n                        \"country\": data.personData.shippingAddress.countryCode,\n                        \"postalCode\": data.personData.shippingAddress.postalCode,\n                        \"phone\": data.personData.phone\n                      }\n                   },\n                   \"payer\": {\n                      \"merchantPayerId\": data.personData.id,\n                      \"fullName\": data.personData.name+' '+data.personData.lastname,\n                      \"emailAddress\": data.personData.email,\n                      \"contactPhone\": data.personData.phone,\n                      \"dniNumber\": data.personData.legalId,\n                      \"billingAddress\": {\n                        \"street1\": data.personData.shippingAddress.street,\n                        \"street2\": \"\",\n                        \"city\": data.personData.shippingAddress.city,\n                        \"state\": data.personData.shippingAddress.state,\n                        \"country\": data.personData.shippingAddress.countryCode,\n                        \"postalCode\": data.personData.shippingAddress.postalCode,\n                        \"phone\": data.personData.phone\n                      }\n                   },\n                   \"creditCard\": {\n                      \"number\": data.cardData.number,\n                      \"securityCode\": data.cardData.securityCode,\n                      \"expirationDate\": data.cardData.expirationDate,\n                      \"name\": data.cardData.name || (data.personData.name+' '+data.personData.lastname)\n                   },\n                   \"extraParameters\": {\n                      \"INSTALLMENTS_NUMBER\": 1\n                   },\n                   \"type\": \"AUTHORIZATION_AND_CAPTURE\",\n                   \"paymentMethod\": data.cardData.type,\n                   \"paymentCountry\": data.cardData.countryCode,\n                   \"deviceSessionId\": data.requestDeviceData.sessionId || '',\n                   \"ipAddress\": data.requestDeviceData.ipAddress,\n                   \"cookie\": data.requestDeviceData.cookie || '',\n                   \"userAgent\": data.requestDeviceData.userAgent\n                },\n             }\n        }).then(function (resp) {\n            if (Math.floor(resp.statusCode/100) == 2) {\n                deferred.resolve(resp.body);\n                return;\n            }\n            deferred.reject(resp);\n        }).catch(function (err) {\n            deferred.reject(err);\n        });\n        return deferred.promise;\n    }\n\n    return transactions;\n}"]}